import { Injectable, Logger } from '@nestjs/common';
import * as fs from 'node:fs';
import * as path from 'node:path';
import admin from 'firebase-admin';

function normalizePrivateKey(pk: string) {
  return pk.replace(/\\n/g, '\n');
}

@Injectable()
export class FirebaseAdminService {
  private readonly log = new Logger(FirebaseAdminService.name);

  constructor() {
    if (admin.apps.length > 0) return;

    const filePath = process.env.FIREBASE_SERVICE_ACCOUNT_PATH;

    // Option A: JSON file path (relative to current cwd)
    if (filePath) {
      const abs = path.isAbsolute(filePath) ? filePath : path.join(process.cwd(), filePath);

      if (!fs.existsSync(abs)) {
        this.log.warn(`Firebase service account not found at: ${abs}`);
        this.log.warn(`Continuing without Firebase Admin (DEV_AUTH_BYPASS must be true for dev sessions).`);
        return;
      }

      try {
        const raw = fs.readFileSync(abs, 'utf-8');
        const json = JSON.parse(raw) as {
          project_id: string;
          client_email: string;
          private_key: string;
        };

        admin.initializeApp({
          credential: admin.credential.cert({
            projectId: json.project_id,
            clientEmail: json.client_email,
            privateKey: json.private_key,
          } as admin.ServiceAccount),
        });

        this.log.log('Firebase Admin initialized (service account file).');
        return;
      } catch (e: any) {
        this.log.warn(`Failed to load Firebase service account JSON: ${e?.message ?? e}`);
        this.log.warn(`Continuing without Firebase Admin (DEV_AUTH_BYPASS must be true for dev sessions).`);
        return;
      }
    }

    // Option B: env vars
    const projectId = process.env.FIREBASE_PROJECT_ID;
    const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;
    const privateKey = process.env.FIREBASE_PRIVATE_KEY;

    if (!projectId || !clientEmail || !privateKey) {
      this.log.warn('Firebase Admin not configured (no service account file or env vars).');
      return;
    }

    admin.initializeApp({
      credential: admin.credential.cert({
        projectId,
        clientEmail,
        privateKey: normalizePrivateKey(privateKey),
      } as admin.ServiceAccount),
    });

    this.log.log('Firebase Admin initialized (env credentials).');
  }

  isConfigured() {
    return admin.apps.length > 0;
  }

  verifyIdToken(idToken: string) {
    return admin.auth().verifyIdToken(idToken);
  }
}
